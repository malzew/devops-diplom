### Дипломный практикум в YandexCloud

### [Полное Задание](TASK.md)

#### Цели:

Зарегистрировать доменное имя (любое на ваш выбор в любой доменной зоне).

Подготовить инфраструктуру с помощью Terraform на базе облачного провайдера YandexCloud.

Настроить внешний Reverse Proxy на основе Nginx и LetsEncrypt.

Настроить кластер MySQL.

Установить WordPress.

Развернуть Gitlab CE и Gitlab Runner.

Настроить CI/CD для автоматического развёртывания приложения.

Настроить мониторинг инфраструктуры с помощью стека: Prometheus, Alert Manager и Grafana.

### Введение

Для решения поставленных задач...

Выбран подход с хранением переменных в terraform...

Запуск ansible из terraform...

Дистрибутив ОС Linux Ubuntu 20.04 LTS потому что... 

### Этапы выполнения:

### 1. Регистрация доменного имени

#### Цель:

Получить возможность выписывать TLS сертификаты для веб-сервера.  

#### Ожидаемые результаты:

У вас есть доступ к личному кабинету на сайте регистратора.

Вы зарезистрировали домен и можете им управлять (редактировать dns записи в рамках этого домена).

---

#### Решение

Зарегистрировано доменное имя:

#### `eladmin.ru`

Доступ к личному кабинету регистратора есть.

Регистратор:

https://reg.ru

1. Зарегистрироваться на Yandex Cloud, привязать платежную карту. Результат - cloud_id
2. Установить утилиту для работы в cli. https://cloud.yandex.ru/docs/cli/quickstart
3. Создать папку для инфраструктуры - создана папка netology. Результат - folder_id

Зона DNS делегирована от регистратора к Yandex Cloud для автоматического создания записей при работе terraform.

https://cloud.yandex.ru/docs/dns/operations/zone-create-public

Ожидаемый результат достигнут.

---

### 2. Создание инфраструктуры  

Для начала необходимо подготовить инфраструктуру в YC при помощи Terraform.

#### Цель:

Повсеместно применять IaaC подход при организации (эксплуатации) инфраструктуры.  

Иметь возможность быстро создавать (а также удалять) виртуальные машины и сети. С целью экономии денег на вашем аккаунте в YandexCloud.  

#### Ожидаемые результаты:

Terraform сконфигурирован и создание инфраструктуры посредством Terraform возможно без дополнительных ручных действий.

---

#### Решение

Версия terraform

```commandline
$ terraform --version
Terraform v1.3.0
on linux_amd64
```

Настройки провайдера Yandex Cloud находятся в файлах
- [provider.tf](./terraform/provider.tf)
- key.json - файл не загружается в репозиторий

Для корректной работы кода необходимо:
 
4. В папке создать сервисный аккаунт с ролью `editor`. https://cloud.yandex.ru/docs/iam/operations/sa/create
5. Создать статический ключ доступа для сервисного аккаунта. Это необходимо для доступа terraform к S3 бакету. Ключ сохраняется в переменных окружания `AWS_ACCESS_KEY_ID = key_id` и `AWS_SECRET_ACCESS_KEY = secret` для постоянного хранения переменных окружения можно использовать файл `~/.bashrc` https://cloud.yandex.ru/docs/iam/operations/sa/create-access-key
6. Создать авторизированный ключ для сервисного аккаунта в файле `key.json` - он используется для доступа terraform к API Yandex Cloud при работе с инфраструктурой. https://cloud.yandex.ru/docs/iam/operations/authorized-key/create
7. Создать Object Storage, он же S3 бакет. Размер можно самый минимальный, установлен 1 Гб. Результат в настройке бакета - bucket

Делаем

```commandline
terraform init
terraform workspace new prod
terraform workspace new stage
terraform workspace select stage
```

Скачиваются необходимые провайдеры terraform и файл состояния terraform хранится в бакете.

Создаются workspaces stage и prod

Дальнейшая работа будет использовать workspace stage. Использование workspace prod занесем в [TODO](./TODO.md)

Сетевая инфраструктура описана в файле [network.tf](./terraform/network.tf)

Возможно создание VPC в разных зонах доступности.

Terraform сконфигурирован и создание инфраструктуры посредством Terraform возможно без дополнительных ручных действий.

Ожидаемый результат достигнут.

---

### 3. Установка Nginx и LetsEncrypt

#### Рекомендации:

• Имя сервера: eladmin.ru  

• Характеристики: 2vCPU, 2 RAM, External address (Public) и Internal address.

#### Цель:

Создать reverse proxy с поддержкой TLS для обеспечения безопасного доступа к веб-сервисам по HTTPS.  

#### Ожидаемые результаты:

В вашей доменной зоне настроены все A-записи на внешний адрес этого сервера:

https://www.eladmin.ru (WordPress)

https://gitlab.eladmin.ru (Gitlab)

https://grafana.eladmin.ru (Grafana)

https://prometheus.eladmin.ru (Prometheus)

https://alertmanager.eladmin.ru (Alert Manager)

В браузере можно открыть любой из этих URL и увидеть ответ сервера (502 Bad Gateway). На текущем этапе выполнение задания это нормально!  

### 4. Установка кластера MySQL

Необходимо разработать Ansible роль для установки кластера MySQL.

#### Рекомендации:

• Имена серверов: db01.eladmin.ru и db02.eladmin.ru

• Характеристики: 4vCPU, 4 RAM, Internal address.

#### Цель:

Получить отказоустойчивый кластер баз данных MySQL.

#### Ожидаемые результаты:

MySQL работает в режиме репликации Master/Slave.  

В кластере автоматически создаётся база данных c именем wordpress.  

В кластере автоматически создаётся пользователь wordpress с полными правами на базу wordpress и паролем wordpress.  

Вы должны понимать, что в рамках обучения это допустимые значения, но в боевой среде использование подобных значений не приемлимо! Считается хорошей практикой использовать логины и пароли повышенного уровня сложности. В которых будут содержаться буквы верхнего и нижнего регистров, цифры, а также специальные символы!

### 5. Установка WordPress

Необходимо разработать Ansible роль для установки WordPress.

#### Рекомендации:

• Имя сервера: app.eladmin.ru

• Характеристики: 4vCPU, 4 RAM, Internal address.

#### Цель:

Установить WordPress. Это система управления содержимым сайта (CMS) с открытым исходным кодом.  

По данным W3techs, WordPress используют 64,7% всех веб-сайтов, которые сделаны на CMS. Это 41,1% всех существующих в мире сайтов. Эту платформу для своих блогов используют The New York Times и Forbes. Такую популярность WordPress получил за удобство интерфейса и большие возможности.

#### Ожидаемые результаты:

Виртуальная машина на которой установлен WordPress и Nginx/Apache (на ваше усмотрение).  

В вашей доменной зоне настроена A-запись на внешний адрес reverse proxy:

https://www.eladmin.ru (WordPress)

На сервере you.domain отредактирован upstream для выше указанного URL и он смотрит на виртуальную машину на которой установлен WordPress.  

В браузере можно открыть URL https://www.eladmin.ru и увидеть главную страницу WordPress.

### 6. Установка Gitlab CE и Gitlab Runner

Необходимо настроить CI/CD систему для автоматического развертывания приложения при изменении кода.

#### Рекомендации:

• Имена серверов: gitlab.eladmin.ru и runner.eladmin.ru  

• Характеристики: 4vCPU, 4 RAM, Internal address.

#### Цель:

Построить pipeline доставки кода в среду эксплуатации, то есть настроить автоматический деплой на сервер app.eladmin.ru при коммите в репозиторий с WordPress.  

#### Ожидаемый результат:

Интерфейс Gitlab доступен по https.  

В вашей доменной зоне настроена A-запись на внешний адрес reverse proxy:

https://gitlab.eladmin.ru (Gitlab)

На сервере you.domain отредактирован upstream для выше указанного URL и он смотрит на виртуальную машину на которой установлен Gitlab.  

При любом коммите в репозиторий с WordPress и создании тега (например, v1.0.0) происходит деплой на виртуальную машину.

### 7. Установка Prometheus, Alert Manager, Node Exporter и Grafana

Необходимо разработать Ansible роль для установки Prometheus, Alert Manager и Grafana.

#### Рекомендации:

• Имя сервера: monitoring.eladmin.ru  

• Характеристики: 4vCPU, 4 RAM, Internal address.

#### Цель:

Получение метрик со всей инфраструктуры.

#### Ожидаемые результаты:

Интерфейсы Prometheus, Alert Manager и Grafana доступены по https.  

В вашей доменной зоне настроены A-записи на внешний адрес reverse proxy:

• https://grafana.eladmin.ru (Grafana)

• https://prometheus.eladmin.ru (Prometheus)

• https://alertmanager.eladmin.ru (Alert Manager)

На сервере you.domain отредактированы upstreams для выше указанных URL и они смотрят на виртуальную машину на которой установлены Prometheus, Alert Manager и Grafana.  

На всех серверах установлен Node Exporter и его метрики доступны Prometheus.  

У Alert Manager есть необходимый набор правил для создания алертов.  

В Grafana есть дашборд отображающий метрики из Node Exporter по всем серверам.  

В Grafana есть дашборд отображающий метрики из MySQL (*).

В Grafana есть дашборд отображающий метрики из WordPress (*).

Примечание: дашборды со звёздочкой являются опциональными заданиями повышенной сложности их выполнение желательно, но не обязательно.

### Что необходимо для сдачи задания?

Репозиторий со всеми Terraform манифестами и готовность продемонстрировать создание всех ресурсов с нуля.

Репозиторий со всеми Ansible ролями и готовность продемонстрировать установку всех сервисов с нуля.

Скриншоты веб-интерфейсов всех сервисов работающих по HTTPS на вашем доменном имени.

https://www.eladmin.ru (WordPress)

https://gitlab.eladmin.ru (Gitlab)

https://grafana.eladmin.ru (Grafana)

https://prometheus.eladmin.ru (Prometheus)

https://alertmanager.eladmin.ru (Alert Manager)

Все репозитории рекомендуется хранить на одном из ресурсов (github.com или gitlab.com).